---
output: 
  flexdashboard::flex_dashboard
params:
  gs_dir: ""
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

```{r libraries, include=FALSE}
library(HIPCCyto)
library(flowWorkspace)
library(ggcyto)
library(plotly)
library(htmltools)
library(htmlwidgets)
library(reactable)
library(bsplus)
library(crosstalk)
```

```{r load, include=FALSE}
gs <- load_gs(file.path(params$gs_dir, "gs"))
pd <- pData(gs)
outliers <- HIPCCyto:::find_outliers(gs)
pd$outlier <- pd$name %in% outliers
pData(gs) <- pd
s <- summarize_gating_set(gs)
```

---
title: `r s$study`
---

Summary
===================================== 

Column
-------------------------------------

### Summary

```{r summary}
reactable(
  data.frame(
    "n_samples" = length(gs),
    "n_markers" = length(markernames(gs)),
    "n_participants" = length(unique(pd$participant_id))
  ),
  sortable = FALSE
)
```

### Gating Hierarchy

```{r nodes}
flowWorkspace::plot(gs)
```

### Panel

```{r panel}
m <- markernames(gs)
reactable(data.frame(Channel = names(m), Marker =  m, row.names = NULL), sortable = FALSE)
```

Column {.tabset}
-------------------------------------

### Study info

```{r study-info}
ImmPortR:::query(sprintf("study/summary/%s", s$study))
```

### Tables

#### Sample types

```{r sample-types}
table(pd$type)
```

#### Timepoints

```{r timepoints}
table(paste(pd$study_time_collected, pd$study_time_collected_unit))
```

#### Cohorts

```{r cohorts}
table(pd$cohort)
```

#### Batches

```{r batches}
table(pd$batch)
```

### Custom processing parameters

```{r parameters}
HIPCCyto:::DATA[[s$study]]
```



Gating
=====================================

Column {.tabset}
-------------------------------------

### Gating Hierarchy

```{r gating-hierarchy}
flowWorkspace::plot(gs)
gates <- HIPCCyto:::get_nodes(gs)
```

### Live gates

```{r live}
if ("Live" %in% gates) {
  suppressWarnings(p <- qc_gates(gs, "Live"))
  ggplotly(p) %>%
    onRender("
      function(el) {
        el.on('plotly_click', function(d) { 
          txt = d.points[0].text.split('<br />');
          console.log(txt);
          i = txt[txt.length - 1].trim();
          id = txt.filter(v => /sample/.test(v))[0].replace('sample: ', '');
          id = id.substring(0, id.search('.fcs')+4).trim();
          console.log(id);
          $('.dropdown-menu li.active').removeClass('active');
          $('.dropdown-tab').parent('li').eq(i-1).addClass('active');
          $('#samples div.active').removeClass('active');
          $('#' + CSS.escape(id)).addClass('active');
          window.open('#by-sample', '_self');
        });
      } 
    ")
} else {
  print("no Live gates")
}
```

### Non-debris gates

```{r nondebris}
if ("Nondebris" %in% gates) {
  suppressWarnings(p <- qc_gates(gs, "Nondebris"))
  ggplotly(p) %>%
    onRender("
      function(el) {
        el.on('plotly_click', function(d) { 
          txt = d.points[0].text.split('<br />');
          console.log(txt);
          i = txt[txt.length - 1].trim();
          id = txt.filter(v => /sample/.test(v))[0].replace('sample: ', '');
          id = id.substring(0, id.search('.fcs')+4).trim();
          console.log(id);
          $('.dropdown-menu li.active').removeClass('active');
          $('.dropdown-tab').parent('li').eq(i-1).addClass('active');
          $('#samples div.active').removeClass('active');
          $('#' + CSS.escape(id)).addClass('active');
          window.open('#by-sample', '_self');
        });
      } 
    ")
} else {
  print("no Nondebris gates")
}
```

### Lymphocytes gates

```{r lymphocytes}
if ("Lymphocytes" %in% gates) {
suppressWarnings(p <- qc_gates(gs, "Lymphocytes"))
ggplotly(p) %>%
  onRender("
    function(el) {
      el.on('plotly_click', function(d) {
        txt = d.points[0].data.text.split('<br />');
        console.log(txt);
        i = txt[txt.length - 1].trim();
        id = txt.filter(v => /sample/.test(v))[0].replace('sample: ', '');
        id = id.substring(0, id.search('.fcs')+4).trim();
        console.log(id);
        $('.dropdown-menu li.active').removeClass('active');
        $('.dropdown-tab').parent('li').eq(i-1).addClass('active');
        $('#samples div.active').removeClass('active');
        $('#' + CSS.escape(id)).addClass('active');
        window.open('#by-sample', '_self');
      });
    } 
  ")
} else {
  print("no Lymphocytes gates")
}
```



By sample  {data-orientation=rows}
===================================== 

Row {data-height=15}
-------------------------------------

```{r samples}
sample_names <- sampleNames(gs)
plotInfo <- lapply(
  seq_along(sample_names), 
  function(i) {
    list(
      name = sample_names[i],
      i = i,
      gates = rmarkdown:::base64_encode_file(file.path(params$gs_dir, sprintf("gates/%s.png", sample_names[i])), base64enc::base64encode),
      spillover = rmarkdown:::base64_encode_file(file.path(params$gs_dir, sprintf("spillover/%s.png", sample_names[i])), base64enc::base64encode),
      pdata = jsonlite::toJSON(pd[i, ], pretty = TRUE)
    )
  })
```

<div class="dropdown">
<button class="dropdown-toggle" type="button" data-toggle="dropdown">
Select Sample
<span class="caret"></span>
</button>
<ul class="dropdown-menu">
      
```{r dropdown}
tagList(
  lapply(
    plotInfo,
    function(thisPlotInfo) {
      if (thisPlotInfo$name == plotInfo[[1]]$name) {
        class <- "active"
      } else {
        class <- ""
      }
      tags$li(
        class = class,
        tags$a(
          id = thisPlotInfo$name,
          href = "#by-sample",
          class = "dropdown-tab",
          thisPlotInfo$name
        )
      )
    }
  )
)
```
      
</ul>

<button id="prev" type="button" onclick="sample_button('previous')">Previous sample</button>
<button id="next" type="button" onclick="sample_button('next')">Next sample</button>

</div>


Row
-------------------------------------

### 

<div id="plots">
<div class="tab-content", id="samples">
    
```{r tabs}
tagList(
  lapply(
    plotInfo, 
    function(thisPlotInfo) {
      if (thisPlotInfo$name == plotInfo[[1]]$name) {
        class <- "tab-pane active"
      } else {
        class <- "tab-pane"
      }
      div(
        id = thisPlotInfo$name,
        class = class,
        div(
          class = "sample-row",
          style = "display: flex;",
          div(
            class = "sample-column",
            style = "flex: 50%; padding: 5px;",
            img(src = thisPlotInfo$gates, style = "height: 700px; width: 100%; object-fit: contain"),
            tag("button", list("Correct lymphocyte gate", id = paste0(thisPlotInfo$name, "-correct"), class = "btn btn-default", onclick = "unflag()", style = "background-color: green")),
            tag("button", list("Incorrect lymphocyte gate", id = paste0(thisPlotInfo$name, "-incorrect"), class = "btn btn-default", onclick = "flag()", style = "background-color: red"))
          ),
          div(
            class = "sample-column",
            style = "flex: 50%; padding: 5px;",
            img(src = thisPlotInfo$spillover, style = "height: 350px; width: 100%; object-fit: contain"),
            pre(code(thisPlotInfo$pdata))
          )
        )
      )
    }
  )
)
```
</div>
</div>

<style>
.dropdown-menu {
   max-height:200px;
   overflow:scroll; 
}
</style>

<script type='text/javascript'>
// This makes the dropdown work  
$('.dropdown-tab').click(function (e) {
    $('.dropdown-menu li.active').removeClass('active');
    $(this).parent('li').addClass('active');
    $('#samples div.active').removeClass('active');
    $('#' + CSS.escape($(this).attr('id'))).addClass('active');
    id = $(this).attr('id');
})

// previous/next sample buttons
function sample_button(dir) {
  x = $("#samples").find(".tab-pane");
  i = x.map(function() { return this.className; }).get().findIndex(i => i === 'tab-pane active');
  ids =  x.map(function() { return this.id; }).get();
  
  if (dir == "previous") {
    i = i - 1;
  }
  if (dir == "next") {
    i = i + 1;
  }
  console.log(i);
  if (i < 0 | i > x.length - 1) {
    alert("no " + dir + " sample...")
  } else {
    id = ids[i];
    console.log(id);
    $('.dropdown-menu li.active').removeClass('active');
    $('.dropdown-tab').parent('li').eq(i).addClass('active');
    $('#samples div.active').removeClass('active');
    $('#' + CSS.escape(id)).addClass('active');
  }
}


function flag() {
  x = $("#samples").find(".tab-pane");
  i = x.map(function() { return this.className; }).get().findIndex(i => i === 'tab-pane active');
  ids =  x.map(function() { return this.id; }).get();
  id = ids[i];
  
  var ct_sel = new crosstalk.SelectionHandle(Object.keys(__crosstalk_groups)[1]);
  if (ct_sel.value.findIndex(x => x === id) == -1) {
    $(".ReactTable").find("input[type=checkbox]").eq(i + 1).click()
  } else {
    alert("This sample is already flagged.")
  }
}

function unflag() {
  x = $("#samples").find(".tab-pane");
  i = x.map(function() { return this.className; }).get().findIndex(i => i === 'tab-pane active');
  ids =  x.map(function() { return this.id; }).get();
  id = ids[i];
  
  var ct_sel = new crosstalk.SelectionHandle(Object.keys(__crosstalk_groups)[1]);
  if (ct_sel.value.findIndex(x => x === id) == -1) {
    alert("This sample is already unflagged.")
  } else {
    $(".ReactTable").find("input[type=checkbox]").eq(i + 1).click()
  }
}
</script>



Marker expression
=====================================

Column {.tabset}
-------------------------------------

### After lymphocyte gate

```{r markers}
img(
  src = rmarkdown:::base64_encode_file(file.path(params$gs_dir, "markers.png"), base64enc::base64encode),
  style = "height: 100%; width: 100%; object-fit: contain"
)
```



Sample metadata
=====================================

```{r modal}
bs_modal(id = "modal", title = "Lymphocyte gate imputation code", body = pre(code(id = "impute")))
bs <- bs_button("Make imputation code", onclick = "create_code()") %>%
  bs_attach_modal(id_modal = "modal")
bs$attribs$class <- ""
bs
```

```{r pData}
data <- SharedData$new(pd)
reactable(data, selection = "multiple", defaultSelected = which(pd$outlier), pagination = FALSE, onClick = JS("
  function(rowInfo, colInfo) {
    console.log(rowInfo);
    i = rowInfo.index;
    id = rowInfo.original.name;
    $('.dropdown-menu li.active').removeClass('active');
    $('.dropdown-tab').parent('li').eq(i).addClass('active');
    $('#samples div.active').removeClass('active');
    $('#' + CSS.escape(id)).addClass('active');
    window.open('#by-sample', '_self');
  }
"))
```

<script>
function create_code() {
  var ct_sel = new crosstalk.SelectionHandle(Object.keys(__crosstalk_groups)[1]);
  code = "impute_gates(gs, outliers = c('" + ct_sel.value.join("', '") + "'))";
  document.getElementById("impute").innerHTML = code;
}
</script>



Session info
===================================== 

```{r session-info}
sessionInfo()
```



Help
===================================== 

Column {.tabset}
-------------------------------------

### Summary

### Gating

### By sample

### Marker expression

### Sample metadata

### Session info

### Help



<style type="text/css"> div.chart-shim { overflow: auto } </style>
